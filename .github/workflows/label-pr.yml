name: Label PR for Auto-Merge

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  label-on-success:
    name: Add Auto-Merge Label
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Get PR from workflow run
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });

            if (pullRequests.length > 0) {
              core.setOutput('pr_number', pullRequests[0].number);
              return pullRequests[0].number;
            }
            return null;

      - name: Add automerge label
        if: steps.get-pr.outputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.get-pr.outputs.pr_number }};

            // Add label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['automerge', 'ready-to-merge']
            });

            console.log(`Added automerge labels to PR #${prNumber}`);

      - name: Post success comment
        if: steps.get-pr.outputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.get-pr.outputs.pr_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: 'âœ… All checks passed! This PR will be auto-merged shortly.'
            });
