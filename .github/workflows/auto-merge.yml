name: Auto Merge PR

on:
  # Trigger when CI checks complete
  check_suite:
    types: [completed]

  # Trigger when PR is approved
  pull_request_review:
    types: [submitted]

  # Trigger when CI workflow completes
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto Merge on Success
    runs-on: ubuntu-latest

    # Only run if CI passed
    if: >
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success') ||
      (github.event_name == 'pull_request_review' && github.event.review.state == 'approved')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Auto-merge PR
        uses: pascalgn/automerge-action@v0.16.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_LABELS: "automerge,ready-to-merge"
          MERGE_METHOD: "squash"
          MERGE_COMMIT_MESSAGE: "pull-request-title"
          MERGE_FORKS: "false"
          MERGE_RETRIES: "6"
          MERGE_RETRY_SLEEP: "10000"
          UPDATE_LABELS: ""
          MERGE_DELETE_BRANCH: "true"

  # Alternative: Simple auto-merge for all green PRs
  simple-auto-merge:
    name: Simple Auto Merge
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Get PR Number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });

            if (pullRequests.length > 0) {
              return pullRequests[0].number;
            }
            return null;

      - name: Enable Auto-Merge
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};

            if (prNumber) {
              try {
                // Try to merge the PR
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'squash'
                });
                console.log(`PR #${prNumber} merged successfully!`);
              } catch (error) {
                console.log(`Could not merge PR #${prNumber}: ${error.message}`);
              }
            }
